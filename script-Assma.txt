title: "Create metanetwork"
output: html_document
date: "2024-02-15"
---

# Load packages

```{r}
library(readr)
library(dplyr)

```

# Import data

```{r}
macrofaune_surface_0 <- read_delim("data/1. barber_taxo2023-09-26.csv", show_col_types = FALSE)[,-1]
macrofaune_volante_0 <- read_delim("~/IFOSSA-anneso/data/1. pantrap_taxo2023-09-08.csv", show_col_types = FALSE) [,-1]
library(readxl)
micro_arthropodes_0 <- read_excel("data/NH_Tri_mesofaune - INRAE MONTPELLER_AM_MH.xlsx")
micro_arthropodes_1 <- read_excel("data/BDD Collemboles - INRAE MONTPELLIER.xlsx")
library(readxl)
nématodes_0 <- read_excel("data/Communautés_avril vf.xlsx", sheet = "Feuil1")
nématodes_1 <- read.table("data/ifossa.mars.txt" , header= TRUE )

```

# Arrange data

## macrofaune_surface

```{r}
# rename columns
macrofaune_surface_0 <- macrofaune_surface_0 %>%  rename( block = bloc, replicate = rep )

# homogeneise code
macrofaune_surface_0$usage[macrofaune_surface_0$usage == 'C'] <- 'MC'
macrofaune_surface_0$usage[macrofaune_surface_0$usage == 'F'] <- 'TP'

macrofaune_surface_0$block[macrofaune_surface_0$block == '1'] <- 'B1'
macrofaune_surface_0$block[macrofaune_surface_0$block == '2'] <- 'B2'
macrofaune_surface_0$block[macrofaune_surface_0$block == '3'] <- 'B3'

macrofaune_surface_0$habitat[macrofaune_surface_0$habitat == 'Cult' | macrofaune_surface_0$habitat == 'cult' ] <- 'C'
macrofaune_surface_0$habitat[macrofaune_surface_0$habitat == 'Forest' | macrofaune_surface_0$habitat == 'LSA' ] <- 'T'

macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '1'] <- 'R1'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '2'] <- 'R2'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '3'] <- 'R3'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '4'] <- 'R4'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '5'] <- 'R5'

# create column full_uhbr
macrofaune_surface <- macrofaune_surface_0
macrofaune_surface$full_uhbr <- paste(macrofaune_surface_0$usage, macrofaune_surface_0$habitat, macrofaune_surface_0$block, macrofaune_surface_0$replicate, sep = "_")
```


# macrofaune_volante 
```{r}
# rename columns
macrofaune_volante_0 <- macrofaune_volante_0 %>%  rename( block = bloc, replicate = rep )

##homogeneise code

macrofaune_volante_0$usage[macrofaune_volante_0$usage == 'C'] <- 'MC'
macrofaune_volante_0$usage[macrofaune_volante_0$usage == 'F'] <- 'TP'

macrofaune_volante_0$block[macrofaune_volante_0$bloc == '1'] <- 'B1'
macrofaune_volante_0$block[macrofaune_volante_0$bloc == '2'] <- 'B2'
macrofaune_volante_0$block[macrofaune_volante_0$bloc == '3'] <- 'B3'

macrofaune_volante_0$habitat[macrofaune_volante_0$habitat == 'Cult' | macrofaune_volante_0$habitat == 'cult' ] <- 'C'
macrofaune_volante_0$habitat[macrofaune_volante_0$habitat == 'Forest' | macrofaune_volante_0$habitat == 'LSA' ] <- 'T'

macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '1'] <- 'R1'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '2'] <- 'R2'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '3'] <- 'R3'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '4'] <- 'R4'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '5'] <- 'R5'

# create column full_uhbr
macrofaune_volante <- macrofaune_volante_0
macrofaune_volante$full_uhbr <- paste (macrofaune_volante_0$usage, macrofaune_volante_0$habitat, macrofaune_volante_0$block, macrofaune_volante_0$replicate, sep = "_")

```

# micro-arthropodes 

```{r}

# vérifier les données tri-mesofaune 
str(micro_arthropodes_0)
unique(micro_arthropodes_0$Nbr_ind_tri)
unique(micro_arthropodes_0$Nbr_identifiés)

##supprimer des lignes qui contient des remarques 
micro_arthropodes_00 <- micro_arthropodes_0 %>% slice(-347:-349) 
##remplacer les NA avec "0"
micro_arthropodes_00<- micro_arthropodes_00 %>%
  mutate(Nbr_identifiés = ifelse(is.na(Nbr_identifiés), 0, Nbr_identifiés),
         Nbr_ind_tri = ifelse(is.na(Nbr_ind_tri), 0, Nbr_ind_tri))

##crée une nv colonne Resultat de soustraction
micro_arthropodes_00$Nbr_ind_tri <- as.numeric(micro_arthropodes_00$Nbr_ind_tri)
micro_arthropodes_00$Nbr_identifiés <- as.numeric(micro_arthropodes_00$Nbr_identifiés) 

micro_arthropodes <- transform(micro_arthropodes_00, Nbr_individus = Nbr_ind_tri - Nbr_identifiés)

##préciser le resultat de nbr_individus juste pour les collemboles 

micro_arthropodes <- micro_arthropodes %>%
  mutate(Nbr_individus = ifelse(row_number() >= 217 & row_number() <= 274, Nbr_ind_tri - Nbr_identifiés, NA))

##fusionner les 2 tableaux 
micro_arthropodes_00<- micro_arthropodes_00 %>% 
  rename(Sites=Num_prélevement)

micro_arthropodes <- bind_rows (micro_arthropodes_00,micro_arthropodes_1)

###homogeneise code
library(dplyr)
library(tidyr)
#j'ai séparé la colonne pour faciliter la manip 
micro_arthropodes <- micro_arthropodes %>% 
  separate(col=Sites, into=c("Sites1","Sites2"), sep="_", remove= FALSE)

# sites1(usage+Block)
micro_arthropodes <- micro_arthropodes %>% 
   mutate(usage = case_when(

    startsWith(Sites1, "C") ~ "MC",

    startsWith(Sites1, "AF") ~ "AF",

    startsWith(Sites1, "F") ~ "TP"),

block = paste0("B", parse_number(Sites1)))

#sites(Habitat+replicate)
micro_arthropodes <- micro_arthropodes %>% 
  mutate(habitat = case_when(
    
    startsWith(Sites2, "C") ~ "C",

    startsWith(Sites2, "LSA") ~ "T"),

replicate = paste0("R", parse_number(Sites2)))

##Full_name_ubhr

micro_arthropodes$full_uhbr <- paste (micro_arthropodes$usage, micro_arthropodes$habitat, micro_arthropodes$block, micro_arthropodes$replicate, sep = "_")


```

# nématodes 
```{r}
##homogeneise code
#Communautés_avril 
nématodes_00 <- nématodes_0 %>%

 mutate(usage = case_when(

    grepl('[[:digit:]]C', Taxa) ~ "MC",

    grepl('[[:digit:]]AF', Taxa) ~ "AF",

    grepl('[[:digit:]]F', Taxa) ~ "TP"),

        habitat = case_when(

    grepl('C$', Taxa) ~ "C",

    grepl('F$|A$', Taxa) ~ "T"),

        block = paste0("B", parse_number(Taxa)))

nématodes_00$full_uhbt <- paste(nématodes_00$usage, nématodes_00$habitat, nématodes_00$block, sep="_")

nématodes_00 <- nématodes_00[,-1] %>% select(full_uhbt, usage, habitat, block, everything())

#ifossa_mars 
nématodes_11<- nématodes_1%>%

  mutate(usage = case_when(

    startsWith(Taxa, "C") ~ "MC",

    startsWith(Taxa, "AF") ~ "AF",

    startsWith(Taxa, "F") ~ "TP"),

        habitat = case_when(

    grepl('^C|^AF_C', Taxa) ~ "C",

    grepl('^F|^AF_A', Taxa) ~ "T"),

        block = paste0("B", parse_number(Taxa)))
nématodes_11$full_uhbt <- paste(nématodes_11$usage, nématodes_11$habitat, nématodes_11$block, sep="_")

nématodes_11<- nématodes_11[,-1] %>% select(full_uhbt, usage, habitat, block, everything())

#fusionner les 2 tableurs 

nématodes <- bind_rows (nématodes_00,nématodes_11)
  
```


# Check our data

```{r}
summary(macrofaune_surface)
view(macrofaune_surface)
dim(macrofaune_surface)
```
