---
title: "Create metanetwork"
output: html_document
date: "2024-02-15"
---

# Load packages

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
```

# Import data

```{r}
macrofaune_surface_0 <- read_delim("data/1. barber_taxo2023-09-26.csv", show_col_types = FALSE)[,-1]
macrofaune_volante_0 <- read_delim("data/1. pantrap_taxo2023-09-08.csv", show_col_types = FALSE)[,-1] # doesn't work for me (anne-so)
macrofaune_foliaire_0 <- read_csv("data/clean_data_robinier_2023-09-16.csv", show_col_types =  FALSE)
micro_arthropodes_all_0 <- read_excel("data/NH_Tri_mesofaune - INRAE MONTPELLER_AM_MH.xlsx")
micro_arthropodes_col_0 <- read_excel("data/BDD Collemboles - INRAE MONTPELLIER.xlsx")
nematodes_a_0 <- read_excel("data/Communautés_avril vf.xlsx", sheet = "Feuil1")
nematodes_m_0 <- read.table("data/ifossa.mars.txt", header= TRUE )
```

# Tidy data and homogeneize code

## macrofaune_surface

```{r}
# rename columns
macrofaune_surface_0 <- macrofaune_surface_0 %>%  rename( block = bloc, replicate = rep )

# homogeneise code
macrofaune_surface_0$usage[macrofaune_surface_0$usage == 'C'] <- 'MC'
macrofaune_surface_0$usage[macrofaune_surface_0$usage == 'F'] <- 'TP'

macrofaune_surface_0$block[macrofaune_surface_0$block == '1'] <- 'B1'
macrofaune_surface_0$block[macrofaune_surface_0$block == '2'] <- 'B2'
macrofaune_surface_0$block[macrofaune_surface_0$block == '3'] <- 'B3'

macrofaune_surface_0$habitat[macrofaune_surface_0$habitat == 'Cult' | macrofaune_surface_0$habitat == 'cult' ] <- 'C'
macrofaune_surface_0$habitat[macrofaune_surface_0$habitat == 'Forest' | macrofaune_surface_0$habitat == 'LSA' ] <- 'T'

macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '1'] <- 'R1'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '2'] <- 'R2'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '3'] <- 'R3'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '4'] <- 'R4'
macrofaune_surface_0$replicate[macrofaune_surface_0$replicate == '5'] <- 'R5'

# create column full_uhbr
macrofaune_surface_1 <- macrofaune_surface_0
macrofaune_surface_1$full_uhbr <- paste(macrofaune_surface_0$usage, macrofaune_surface_0$habitat, macrofaune_surface_0$block, macrofaune_surface_0$replicate, sep = "_")
```

## macrofaune_volante

```{r }
# rename columns
macrofaune_volante_0 <- macrofaune_volante_0 %>%  rename( block = bloc, replicate = rep )

# homogeneise code

macrofaune_volante_0$usage[macrofaune_volante_0$usage == 'C'] <- 'MC'
macrofaune_volante_0$usage[macrofaune_volante_0$usage == 'F'] <- 'TP'

macrofaune_volante_0$block[macrofaune_volante_0$block == '1'] <- 'B1'
macrofaune_volante_0$block[macrofaune_volante_0$block == '2'] <- 'B2'
macrofaune_volante_0$block[macrofaune_volante_0$block == '3'] <- 'B3'

macrofaune_volante_0$habitat[macrofaune_volante_0$habitat == 'Cult' | macrofaune_volante_0$habitat == 'cult' ] <- 'C'
macrofaune_volante_0$habitat[macrofaune_volante_0$habitat == 'Forest' | macrofaune_volante_0$habitat == 'LSA' ] <- 'T'

macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '1'] <- 'R1'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '2'] <- 'R2'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '3'] <- 'R3'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '4'] <- 'R4'
macrofaune_volante_0$replicate[macrofaune_volante_0$replicate == '5'] <- 'R5'

# create column full_uhbr

macrofaune_volante_1 <- macrofaune_volante_0
macrofaune_volante_1$full_uhbr <- paste (macrofaune_volante_0$usage, macrofaune_volante_0$habitat, macrofaune_volante_0$block, macrofaune_volante_0$replicate, sep = "_")
```

## macrofaune_foliaire

```{r}
# homogeneise code
macrofaune_foliaire_0 <- macrofaune_foliaire_0 %>% 
   separate(col = usage_bloc , into = c("usage","bloc","rang","arbre"), sep = "_")
  
macrofaune_foliaire_0 <- macrofaune_foliaire_0 %>% 
   mutate(rang = gsub("rang", "R", rang)) 

macrofaune_foliaire_0 <- macrofaune_foliaire_0 %>% 
  mutate(arbre = gsub("arbre", "", arbre))

macrofaune_foliaire_0 <- macrofaune_foliaire_0 %>% 
  mutate(replicate = paste(rang, arbre ,sep="."))

macrofaune_foliaire_0 <- macrofaune_foliaire_0 %>%   rename( block = bloc )

macrofaune_foliaire_0$block[macrofaune_foliaire_0$block == '1'] <- 'B1'
macrofaune_foliaire_0$block[macrofaune_foliaire_0$block == '2'] <- 'B2'
macrofaune_foliaire_0$block[macrofaune_foliaire_0$block == '3'] <- 'B3'

# create column full_uhbr
macrofaune_foliaire_1 <- macrofaune_foliaire_0
macrofaune_foliaire_1$full_uhbr <- paste (macrofaune_foliaire_0$usage, macrofaune_foliaire_0$block, macrofaune_foliaire_0$replicate, sep = "_")
```

## micro-arthropodes 

```{r}
# tidy data
## vérifier les données tri-mesofaune 
str(micro_arthropodes_all_0)
unique(micro_arthropodes_all_0$Nbr_ind_tri)
unique(micro_arthropodes_all_0$Nbr_identifiés)

## supprimer des lignes qui contient des remarques 
micro_arthropodes_all_1 <- micro_arthropodes_all_0 %>% slice(-347:-349)

## remplacer les NA par "0"
micro_arthropodes_all_1 <- micro_arthropodes_all_1 %>%
  mutate(Nbr_identifiés = ifelse(is.na(Nbr_identifiés), 0, Nbr_identifiés),
         Nbr_ind_tri = ifelse(is.na(Nbr_ind_tri), 0, Nbr_ind_tri))

## créer une nv colonne Nbr_individus_final
micro_arthropodes_all_1$Nbr_ind_tri <- as.numeric(micro_arthropodes_all_1$Nbr_ind_tri)
micro_arthropodes_all_1$Nbr_identifiés <- as.numeric(micro_arthropodes_all_1$Nbr_identifiés) 

micro_arthropodes_all_2 <- transform(micro_arthropodes_all_1, Nbr_individus_final = Nbr_ind_tri - Nbr_identifiés)

## fusionner les 2 fichiers 
micro_arthropodes_all_2 <- micro_arthropodes_all_2 %>% 
  rename(Sites=Num_prélevement)

micro_arthropodes_3 <- bind_rows(micro_arthropodes_all_2, micro_arthropodes_col_0)

##best_id résultat de colonne Noms_espèces des col

micro_arthropodes_3$best_ID <- replace(micro_arthropodes_3$best_ID,is.na(micro_arthropodes_3$best_ID),"")

micro_arthropodes_3$Noms_espèces <- replace(micro_arthropodes_3$Noms_espèces,is.na(micro_arthropodes_3$Noms_espèces),"")

micro_arthropodes_3 $espèces_ID <-
  paste(micro_arthropodes_3$best_ID,micro_arthropodes_3$Noms_espèces)
 ## on peux supprimer les colonnes best_ID noms_especes psq je lai remplacé par une nouvelle colonne espéces_ID  
```

```{r}
# homogeneise code

## j'ai séparé la colonne pour faciliter la manip 
micro_arthropodes_3 <- micro_arthropodes_3 %>% 
  separate(col=Sites, into=c("Sites1","Sites2"), sep="_", remove= FALSE)

## sites1(usage+Block)
micro_arthropodes_3 <- micro_arthropodes_3 %>% 
   mutate(usage = case_when(

    startsWith(Sites1, "C") ~ "MC",

    startsWith(Sites1, "AF") ~ "AF",

    startsWith(Sites1, "F") ~ "TP"),

block = paste0("B", parse_number(Sites1)))

## sites(Habitat+replicate)
micro_arthropodes_3 <- micro_arthropodes_3 %>% 
  mutate(habitat = case_when(
    
    startsWith(Sites2, "C") ~ "C",

    startsWith(Sites2, "LSA") ~ "T"),

replicate = paste0("R", parse_number(Sites2)))

## Full_name_ubhr
micro_arthropodes_3$full_uhbr <- paste (micro_arthropodes_3$usage, micro_arthropodes_3$habitat, micro_arthropodes_3$block, micro_arthropodes_3$replicate, sep = "_")
```

# nematodes

```{r}
# homogeneise code

## april
nematodes_a_1 <- nematodes_a_0 %>%

 mutate(usage = case_when(

    grepl('[[:digit:]]C', Taxa) ~ "MC",

    grepl('[[:digit:]]AF', Taxa) ~ "AF",

    grepl('[[:digit:]]F', Taxa) ~ "TP"),

        habitat = case_when(

    grepl('C$', Taxa) ~ "C",

    grepl('F$|A$', Taxa) ~ "T"),

        block = paste0("B", parse_number(Taxa)))

nematodes_a_1$full_uhbt <- paste(nematodes_a_1$usage, nematodes_a_1$habitat, nematodes_a_1$block, sep="_")

nematodes_a_1 <- nematodes_a_1[,-1] %>% select(full_uhbt, usage, habitat, block, everything())

## march
nematodes_m_1 <- nematodes_m_0 %>%

  mutate(usage = case_when(

    startsWith(Taxa, "C") ~ "MC",

    startsWith(Taxa, "AF") ~ "AF",

    startsWith(Taxa, "F") ~ "TP"),

        habitat = case_when(

    grepl('^C|^AF_C', Taxa) ~ "C",

    grepl('^F|^AF_A', Taxa) ~ "T"),

        block = paste0("B", parse_number(Taxa)))
nematodes_m_1$full_uhbt <- paste(nematodes_m_1$usage, nematodes_m_1$habitat, nematodes_m_1$block, sep="_")

nematodes_m_1<- nematodes_m_1[,-1] %>% select(full_uhbt, usage, habitat, block, everything()) # je n'est poas inclu time 

# bind data
nematodes_1 <- bind_rows (nematodes_a_1,nematodes_m_1)
#remplacer Na par 0
for (col in names(nematodes_1)) {
  nematodes_1[[col]] <- replace(nematodes_1[[col]], is.na(nematodes_1[[col]]), 0)}

#  pivot_longer wider pour avoir le même format que les autres

nematodes_1_F <- pivot_longer(nematodes_1, cols= c(Acrobeles,  Acrobeloides, Aporcelaimidae, Aprutides, Cervidellus, Chiloplacus, Eumonhystera, Anaplecetus, Plectus, Tylocephalus, Panagrolaimus, Rhabditidae, Rhabdolaimus, Prismatolaimus, Aphelenchus, Aphelenchoides, Diphtherophora, Mononchus, Microdorylaimus, Nygolaimidae, Discolaimus, Oxydirus, Eudorylaimus, Pratylenchus, Prodorylaimus, Helicotylenchus, Trichodorus, Tylenchorhynchus, Tylenchidae, Mylonchulus) ,  names_to =  "espéces_ID" , values_to = "Nbr_individus")

# supprimer les doublons 
nematodes_1_Final <- distinct(nematodes_1_F) 

```

# Check our data

```{r}
summary(macrofaune_surface)
view(macrofaune_surface)
dim(macrofaune_surface)
print (nematodes)
write.csv()
```

# Combine data
```{r}
# data to use
# ranger le tableau 
##macrofaune_surface_1
macrofaune_surface_1 <- macrofaune_surface_1 [, c(ncol(macrofaune_surface_1), 1:(ncol(macrofaune_surface_1) - 1))]
macrofaune_surface_1 <- macrofaune_surface_1 %>% 
  select(id_sample, everything())

macrofaune_surface_1 <- macrofaune_surface_1 %>% 
  mutate(mass = if_else(is.na(mass), 0, mass))

macrofaune_surface_1 <- macrofaune_surface_1 %>%  
  select(-Year)
macrofaune_surface_1 <- macrofaune_surface_1 %>% 
  select(-c(usage, block, treatment, replicate, habitat))
macrofaune_surface_1 <- macrofaune_surface_1 %>% 
  select(-c(Species, Family, Class, stade, mass, fullName))

##macrofaune_volante_1
macrofaune_volante_1 <- macrofaune_volante_1 %>% 
  select(-c(treatment, code, modalite, INat,usage, block, replicate, habitat, month, fullName, stade, year ))

macrofaune_volante_1 <- relocate(macrofaune_volante_1, full_uhbr, .before = name)
macrofaune_volante_1<- relocate(macrofaune_volante_1, name, .after = abundance)
macrofaune_volante_1<- relocate(macrofaune_volante_1, rankName, .before = genusName)  
                                
#####macrofaune_volante_1 <- macrofaune_volante_1 [, c(ncol(macrofaune_volante_1), 1:(ncol(macrofaune_volante_1) - 1))]

macrofaune_volante_1 <- macrofaune_volante_1 %>% 
  select(id_sample, everything())

##macrofaune_foliaire_1
macrofaune_foliaire_1 <-macrofaune_foliaire_1 %>% 
  select(-c(...1, usage, replicate, rang, arbre, method, fullName, block, Year, Id_campaign, Valid.Name))

macrofaune_foliaire_1 <- macrofaune_foliaire_1 [, c(ncol(macrofaune_foliaire_1), 1:(ncol(macrofaune_foliaire_1) - 1))]

macrofaune_foliaire_1 <- macrofaune_foliaire_1 %>% 
  select(id_sample,full_uhbr, everything())

## micro_arthropodes_3
micro_arthropodes_3 <-micro_arthropodes_3 %>% 
select(-c(Sites, Sites1, Sites2, Nbr_individus, Nbr_identifiés, Nbr_ind_tri, Nbr_ind_montés.sur.lames, Observateur,...6, ...12, ...13, Remarques, best_ID, Noms_espèces, block, usage, replicate, habitat, Noms_espèces ))

micro_arthropodes_3 <- micro_arthropodes_3 [, c(ncol(micro_arthropodes_3), 1:(ncol(micro_arthropodes_3) - 1))]

micro_arthropodes_3 <- micro_arthropodes_3 %>% 
  select(full_uhbr, espèces_ID, everything())

##nematodes_1_Final 
nematodes_1_Final <-nematodes_1_Final %>% 
  select(-c(usage, habitat, block))

#full_data
full_macrofaune <- rbind(macrofaune_volante_1,macrofaune_surface_1,macrofaune_foliaire_1)

install.packages("openxlsx")
library(openxlsx)
write.xlsx(full_macrofaune, "C:\\Users\\assma\\OneDrive\\Documents\\IFOSSA-anneso\\full_macrofaune.xlsx")


# utiliser le package taxize pour homogénéiser la taxonomie
library(taxize)


###classification() :pour classer les noms scientifiques des espèces

classification("genusName ", db = "ncbi")

full_macrofaune$classification(full_macrofaune$Nom_scientifique )

```

 ```




