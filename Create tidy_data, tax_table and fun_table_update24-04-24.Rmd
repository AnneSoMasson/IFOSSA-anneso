---
title: "Create tidy_data, tax_table and fun_table"
output: html_document
date: "2024-02-15"
---

# 0. Load packages and import data

```{r warning=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
library(janitor)
library(stringr)
library(taxize)
library(rgbif)
```

suffix _0 = raw data

```{r message=FALSE, warning=FALSE}
macrofaune_surface_0 <- read_delim("data/1. barber_taxo2023-09-26.csv", show_col_types = FALSE)[,-1]

macrofaune_aerial_0 <- read_csv("data/1. pantrap_taxo2023-09-08.csv", show_col_types = FALSE)[,-1]

macrofaune_foliar_0 <- read_csv("data/clean_data_robinier_2023-09-16.csv", show_col_types =  FALSE)[,-1]

micro_arthropodes_all_0 <- read_excel("data/NH_Tri_mesofaune - INRAE MONTPELLER_AM_MH.xlsx")[,-c(11,12)]
micro_arthropodes_col_0 <- read_excel("data/BDD Collemboles - INRAE MONTPELLIER.xlsx")

nematodes_0 <- read_excel("data/raw data march april 2023.xlsx")

bacteria_0 <- read_delim("data/OTU_Table_Bacterie.tsv")[,c(0:72)]

fungi_0 <- read_delim("data/OTU_Table_Champignon.tsv")[,c(0:72)]

cercozoa_0 <- read_delim("data/OTU_Table_Cercozoa.tsv")[,c(0:72)]

metadata_mo_0 <- read_delim("data/mapping_brut.csv")
```

# 1. Tidy data

suffix _1 = cleaned data

## macrofaune_surface

```{r}
macrofaune_surface_1 <- macrofaune_surface_0

# rename columns
macrofaune_surface_1 <- macrofaune_surface_1 %>%  rename(block = bloc, replicate = rep)

# add column method, date and community
macrofaune_surface_1 <- macrofaune_surface_1 %>% mutate(method = "barber_trap")
macrofaune_surface_1 <- macrofaune_surface_1 %>% mutate(date = "XX/XX/2023")
macrofaune_surface_1 <- macrofaune_surface_1 %>% mutate(community = "macrofaune_surface")

# homogeneise code
macrofaune_surface_1$usage[macrofaune_surface_1$usage == 'C'] <- 'MC'
macrofaune_surface_1$usage[macrofaune_surface_1$usage == 'F'] <- 'TP'

macrofaune_surface_1$block[macrofaune_surface_1$block == '1'] <- 'B1'
macrofaune_surface_1$block[macrofaune_surface_1$block == '2'] <- 'B2'
macrofaune_surface_1$block[macrofaune_surface_1$block == '3'] <- 'B3'

macrofaune_surface_1$habitat[macrofaune_surface_1$habitat == 'Cult' | macrofaune_surface_1$habitat == 'cult' ] <- 'C'
macrofaune_surface_1$habitat[macrofaune_surface_1$habitat == 'Forest' | macrofaune_surface_1$habitat == 'LSA' ] <- 'T'

macrofaune_surface_1$replicate[macrofaune_surface_1$replicate == '1'] <- 'R1'
macrofaune_surface_1$replicate[macrofaune_surface_1$replicate == '2'] <- 'R2'
macrofaune_surface_1$replicate[macrofaune_surface_1$replicate == '3'] <- 'R3'
macrofaune_surface_1$replicate[macrofaune_surface_1$replicate == '4'] <- 'R4'
macrofaune_surface_1$replicate[macrofaune_surface_1$replicate == '5'] <- 'R5'

# create column full_uhbr
macrofaune_surface_1$full_uhbr <- paste(macrofaune_surface_1$usage, macrofaune_surface_1$habitat, macrofaune_surface_1$block, macrofaune_surface_1$replicate, sep = "_")
```

## macrofaune_aerial

```{r }
macrofaune_aerial_1 <- macrofaune_aerial_0

# rename columns
macrofaune_aerial_1 <- macrofaune_aerial_1 %>%  rename(block = bloc, replicate = rep)

# add column method, date and community
macrofaune_aerial_1 <- macrofaune_aerial_1 %>% mutate(method = "pan_trap")
macrofaune_aerial_1 <- macrofaune_aerial_1 %>%
  mutate(date = case_when(
    grepl('03/23', month) ~ "XX/03/2023",
    grepl('04/23', month) ~ "XX/04/2023"))
macrofaune_aerial_1 <- macrofaune_aerial_1 %>% mutate(community = "macrofaune_aerial")

# homogeneise code
macrofaune_aerial_1$usage[macrofaune_aerial_1$usage == 'C'] <- 'MC'
macrofaune_aerial_1$usage[macrofaune_aerial_1$usage == 'F'] <- 'TP'

macrofaune_aerial_1$block[macrofaune_aerial_1$block == '1'] <- 'B1'
macrofaune_aerial_1$block[macrofaune_aerial_1$block == '2'] <- 'B2'
macrofaune_aerial_1$block[macrofaune_aerial_1$block == '3'] <- 'B3'

macrofaune_aerial_1$habitat[macrofaune_aerial_1$habitat == 'Cult' | macrofaune_aerial_1$habitat == 'cult' ] <- 'C'
macrofaune_aerial_1$habitat[macrofaune_aerial_1$habitat == 'Forest' | macrofaune_aerial_1$habitat == 'LSA' ] <- 'T'

macrofaune_aerial_1$replicate[macrofaune_aerial_1$replicate == '1'] <- 'R1'
macrofaune_aerial_1$replicate[macrofaune_aerial_1$replicate == '2'] <- 'R2'
macrofaune_aerial_1$replicate[macrofaune_aerial_1$replicate == '3'] <- 'R3'
macrofaune_aerial_1$replicate[macrofaune_aerial_1$replicate == '4'] <- 'R4'
macrofaune_aerial_1$replicate[macrofaune_aerial_1$replicate == '5'] <- 'R5'

# create column full_uhbr
macrofaune_aerial_1$full_uhbr <- paste(macrofaune_aerial_1$usage, macrofaune_aerial_1$habitat, macrofaune_aerial_1$block, macrofaune_aerial_1$replicate, sep = "_")
```

## macrofaune_foliar

```{r}
macrofaune_foliar_1 <- macrofaune_foliar_0

# modify column method
macrofaune_foliar_1$method[macrofaune_foliar_0$method == 'rameau'] <- 'twig'
macrofaune_foliar_1$method[macrofaune_foliar_1$method == 'dissection inflo'] <- 'inflorescence'

# add column habitat, date and community
macrofaune_foliar_1 <- macrofaune_foliar_1 %>% mutate(habitat = "T")
macrofaune_foliar_1 <- macrofaune_foliar_1 %>% mutate(date = "XX/XX/2023")
macrofaune_foliar_1 <- macrofaune_foliar_1 %>% mutate(community = "macrofaune_foliar")

# homogeneise code
macrofaune_foliar_1 <- macrofaune_foliar_1 %>% 
   separate(col = usage_bloc , into = c("usage","block","rang","arbre"), sep = "_")

macrofaune_foliar_1 <- macrofaune_foliar_1 %>% mutate(across('rang', str_replace, 'arbre', ''))
  
macrofaune_foliar_1 <- macrofaune_foliar_1 %>% 
   mutate(rang = gsub("rang", "R", rang)) 

macrofaune_foliar_1 <- macrofaune_foliar_1 %>% 
  mutate(arbre = gsub("arbre", "", arbre))

macrofaune_foliar_1 <- macrofaune_foliar_1 %>% 
  mutate(replicate = paste(rang, arbre ,sep="."))

macrofaune_foliar_1$block[macrofaune_foliar_1$block == '1'] <- 'B1'
macrofaune_foliar_1$block[macrofaune_foliar_1$block == '2'] <- 'B2'
macrofaune_foliar_1$block[macrofaune_foliar_1$block == '3'] <- 'B3'

# create column full_uhbr
macrofaune_foliar_1$full_uhbr <- paste(macrofaune_foliar_1$usage, macrofaune_foliar_1$habitat, macrofaune_foliar_1$block, macrofaune_foliar_1$replicate, sep = "_")
```

## nematodes

### march

```{r}
nematodes_m_0 <- nematodes_0[15:27,2:26]
nematodes_m_0 <- nematodes_m_0 %>% row_to_names(row_number = 1)
nematodes_m_0 <- nematodes_m_0 %>% mutate_at(-c(1,2), as.numeric) %>% mutate_if(is.numeric, round, digits=3)

# add columns replicate, date, method and community
nematodes_m_0 <- nematodes_m_0 %>% mutate(replicate = "R1")
nematodes_m_0 <- nematodes_m_0 %>% mutate(date = "XX/03/2023")
nematodes_m_0 <- nematodes_m_0 %>% mutate(method = "baermann")
nematodes_m_0 <- nematodes_m_0 %>% mutate(community = "nematodes")

# homogeneise code
nematodes_m_0 <- nematodes_m_0 %>%
  mutate(
    usage = case_when(
      Taxa == "Tree plantation" ~ "TP",
      Taxa == "Annual crop" ~ "MC",
      Taxa == "Under tree in AF" |  Taxa == "Under annual crop in AF" ~ "AF"),
    habitat = case_when(
      Taxa == "Tree plantation" | Taxa == "Under tree in AF" ~ "T",
      Taxa == "Annual crop" | Taxa == "Under annual crop in AF" ~ "C"),
    block = paste0("B", parse_number(Block))
    )

# create column full_uhbr
nematodes_m_0$full_uhbr <- paste(nematodes_m_0$usage, nematodes_m_0$habitat, nematodes_m_0$block, nematodes_m_0$replicate, sep="_")
```

### april

```{r}
nematodes_a_0 <- nematodes_0[1:13,2:32]
nematodes_a_0 <- nematodes_a_0 %>% row_to_names(row_number = 1)
nematodes_a_0 <- nematodes_a_0 %>% mutate_at(-c(1,2), as.numeric) %>% mutate_if(is.numeric, round, digits=3)

# add columns replicate, date, method and community
nematodes_a_0 <- nematodes_a_0 %>% mutate(replicate = "R1")
nematodes_a_0 <- nematodes_a_0 %>% mutate(date = "17/04/2023")
nematodes_a_0 <- nematodes_a_0 %>% mutate(method = "baermann")
nematodes_a_0 <- nematodes_a_0 %>% mutate(community = "nematodes")

# homogeneise code
nematodes_a_0 <- nematodes_a_0 %>%
  mutate(
    usage = case_when(
      Taxa == "Tree plantation" ~ "TP",
      Taxa == "Annual crop" ~ "MC",
      Taxa == "Under tree in AF" |  Taxa == "Under annual crop in AF" ~ "AF"),
    habitat = case_when(
      Taxa == "Tree plantation" | Taxa == "Under tree in AF" ~ "T",
      Taxa == "Annual crop" | Taxa == "Under annual crop in AF" ~ "C"),
    block = paste0("B", parse_number(Block))
    )

# create column full_uhbr
nematodes_a_0$full_uhbr <- paste(nematodes_a_0$usage, nematodes_a_0$habitat, nematodes_a_0$block, nematodes_a_0$replicate, sep="_")
```

### all

```{r}
# bind and pivot data
nematodes_1 <- bind_rows(nematodes_a_0[,-c(1,2)], nematodes_m_0[,-c(1,2)])
nematodes_1 <- nematodes_1 %>% replace(is.na(.), 0)
nematodes_1 <- nematodes_1 %>% select(full_uhbr, usage, habitat, block, replicate, date, method, community, everything())
nematodes_1 <- pivot_longer(nematodes_1, cols = c(9:38), names_to = "taxa", values_to = "abundance")
nematodes_1 <- nematodes_1 %>% rename(name=taxa)
nematodes_1$abundance <- lapply(nematodes_1$abundance, round)
```

## micro-arthropodes

```{r}
micro_arthropodes_all_1 <- micro_arthropodes_all_0

# delete 3 last rows (they are not samples)
micro_arthropodes_all_1 <- micro_arthropodes_all_1 %>% slice(-c(346:348))

# remplace NA by 0 for abundance
micro_arthropodes_all_1 <- micro_arthropodes_all_1 %>%
  mutate(Nbr_identifiés = ifelse(is.na(Nbr_identifiés), 0, Nbr_identifiés),
         Nbr_ind_tri = ifelse(is.na(Nbr_ind_tri), 0, Nbr_ind_tri))

# add column Nbr_individus_final = Nbr_ind_tri - Nbr_identifiés
## Nbr_ind_tri is the total number of individuals
## Nbr_identifiés is the number of collembola more precisely identified
## Nbr_individus_final is needed because not all collembola have been identified
micro_arthropodes_all_1$Nbr_ind_tri <- as.numeric(micro_arthropodes_all_1$Nbr_ind_tri)
micro_arthropodes_all_1$Nbr_identifiés <- as.numeric(micro_arthropodes_all_1$Nbr_identifiés) 

micro_arthropodes_all_1 <- transform(micro_arthropodes_all_1, Nbr_individus_final = Nbr_ind_tri - Nbr_identifiés)

# add collembola identified
micro_arthropodes_all_1 <- micro_arthropodes_all_1 %>% 
  rename(Sites=Num_prélevement)

micro_arthropodes_1 <- bind_rows(micro_arthropodes_all_1, micro_arthropodes_col_0)

# add a unique column abundance
micro_arthropodes_1 <- micro_arthropodes_1 %>% mutate(abundance = coalesce(Nbr_individus_final, Nbr_individus))
micro_arthropodes_1 <- micro_arthropodes_1 %>% mutate(name = coalesce(Noms_espèces, best_ID))

# add columns date, method and community
micro_arthropodes_1 <- micro_arthropodes_1 %>% mutate(date = "XX/XX/2023")
micro_arthropodes_1 <- micro_arthropodes_1 %>% mutate(method = "macfayden")
micro_arthropodes_1 <- micro_arthropodes_1 %>% mutate(community = "micro_arthropodes")

# homogeneise code
micro_arthropodes_1 <- micro_arthropodes_1 %>%
 mutate(usage = case_when(
    grepl('C[[:digit:]]_', Sites) ~ "MC",
    grepl('AF[[:digit:]]_', Sites) ~ "AF",
    grepl('F[[:digit:]]_', Sites) ~ "TP"),
        habitat = case_when(
    grepl('C[[:digit:]]_|AF[[:digit:]]_C', Sites) ~ "C",
    grepl('F[[:digit:]]_|AF[[:digit:]]_LSA', Sites) ~ "T"),
        block = case_when(
    grepl('1_', Sites) ~ "B1",
    grepl('2_', Sites) ~ "B2",
    grepl('3_', Sites) ~ "B3"),
        replicate = case_when(
    grepl('_C1|_LSA1', Sites) ~ "R1",
    grepl('_C2|_LSA2', Sites) ~ "R2",
    grepl('_C3|_LSA3', Sites) ~ "R3",
    grepl('_C4|_LSA4', Sites) ~ "R4",
    grepl('_C5|_LSA5', Sites) ~ "R5"))

# create column full_uhbr
micro_arthropodes_1$full_uhbr <- paste(micro_arthropodes_1$usage, micro_arthropodes_1$habitat, micro_arthropodes_1$block, micro_arthropodes_1$replicate, sep="_")
```

## micro-organisms

```{r}
metadata_mo_1 <- metadata_mo_0

# rename columns
metadata_mo_1 <- metadata_mo_1[c(1:60),] %>%  rename(block = Bloc, replicate = REP, habitat = HABITAT)

# add columns date and method
metadata_mo_1 <- metadata_mo_1 %>% mutate(date = "XX/XX/2023")
metadata_mo_1 <- metadata_mo_1 %>% mutate(method = "metabarcoding")

# homogeneise code
metadata_mo_1$usage[metadata_mo_1$usage == 'C'] <- 'MC'
metadata_mo_1$usage[metadata_mo_1$usage == 'F'] <- 'TP'

metadata_mo_1$block <- paste0("B", parse_number(metadata_mo_1$block))

metadata_mo_1$habitat[metadata_mo_1$habitat == 'Tree_line' | metadata_mo_1$habitat == 'Tree_plantation' ] <- 'T'
metadata_mo_1$habitat[metadata_mo_1$habitat == 'Crop' ] <- 'C'

metadata_mo_1$replicate <- paste0("R", parse_number(metadata_mo_1$replicate))

# create column full_uhbr
metadata_mo_1$full_uhbr <- paste (metadata_mo_1$usage, metadata_mo_1$habitat, metadata_mo_1$block, metadata_mo_1$replicate, sep = "_")
```

### bacteria

```{r}
bacteria_1 <- bacteria_0

bacteria_1 <- pivot_longer(bacteria_1, cols = c(13:72), names_to =  "Reference_ADNid", values_to = "abundance", names_repair = "minimal")

bacteria_1$Reference_ADNid <- str_replace(bacteria_1$Reference_ADNid, '_.+_.+', "")

bacteria_1 <- left_join(bacteria_1, metadata_mo_1, by = "Reference_ADNid")

bacteria_1 <- bacteria_1 %>% mutate(community = "bacteria")
```

### fungi

```{r}
fungi_1 <- fungi_0

fungi_1 <- pivot_longer(fungi_1, cols = c(13:72), names_to =  "Reference_ADNid", values_to = "abundance", names_repair = "minimal")

fungi_1$Reference_ADNid <- str_replace(fungi_1$Reference_ADNid, '_.+_.+', "")

fungi_1 <- left_join(fungi_1, metadata_mo_1, by = "Reference_ADNid")

fungi_1 <- fungi_1 %>% mutate(community = "fungi")
```

### protists

```{r}
cercozoa_1 <- cercozoa_0

cercozoa_1 <- pivot_longer(cercozoa_1, cols = c(13:72), names_to =  "Reference_ADNid", values_to = "abundance", names_repair = "minimal")

cercozoa_1$Reference_ADNid <- str_replace(cercozoa_1$Reference_ADNid, '_.+_.+', "")

cercozoa_1 <- left_join(cercozoa_1, metadata_mo_1, by = "Reference_ADNid")

cercozoa_1 <- cercozoa_1 %>% mutate(community = "cercozoa")
```

At this step, the files with cleaned data (suffix _1) are:
  macrofaune_surface
  macrofaune_aerial
  macrofaune_foliar
  micro_arthropodes
  nematodes
  bacteria
  fungi
  cercozoa

# Export tidy_data

```{r}
# Select minimal data to export

macrofaune_surface_exp <- macrofaune_surface_1 %>% 
  select(full_uhbr, name, abundance, method, community)
# stade and mass can be used for traits
# fullName, genusName, familyName, orderName, className, phylumName will be regenerated in another tax_table

macrofaune_aerial_exp <- macrofaune_aerial_1 %>% 
  select(full_uhbr, name, abundance, method, community)
# INat can be used for ID and stade can be used for traits
# fullName, genusName, familyName, orderName, className, phylumName will be regenerated in another tax_table

macrofaune_foliar_exp <- macrofaune_foliar_1 %>% 
  select(full_uhbr, name, abundance, method, community)
# Valid.Name (what is it?)
# fullName, genusName, familyName, orderName, className, phylumName will be regenerated in another tax_table

nematodes_exp <- nematodes_1 %>% select(full_uhbr, name, abundance, method, community)
nematodes_exp$abundance = as.numeric(nematodes_exp$abundance)

micro_arthropodes_exp <- micro_arthropodes_1 %>% select(full_uhbr, name, abundance, method, community)
# stade can be used for traits
# higher.level and lower.level will be regenerated in another tax_table

bacteria_exp <- bacteria_1 %>% 
  select(full_uhbr, seed_id, abundance, method, community)
bacteria_exp <- bacteria_exp %>%  rename(name = seed_id)

fungi_exp <- fungi_1 %>% 
  select(full_uhbr, seed_id, abundance, method, community)
fungi_exp <- fungi_exp %>%  rename(name = seed_id)

cercozoa_exp <- cercozoa_1 %>% 
  select(full_uhbr, seed_id, abundance, method, community)
cercozoa_exp <- cercozoa_exp %>%  rename(name = seed_id)
```

```{r}
all_exp <- bind_rows(macrofaune_surface_exp, macrofaune_aerial_exp, macrofaune_foliar_exp, nematodes_exp, micro_arthropodes_exp, bacteria_exp, fungi_exp, cercozoa_exp)
tidy_data <- aggregate(all_exp$abundance, by=list(full_uhbr=all_exp$full_uhbr, name=all_exp$name, method=all_exp$method, community=all_exp$community), FUN=sum) %>% rename(abundance = x)
write.csv(all_exp, "intermediate_files/tidy_data_update25-04-24.csv") # Very large file
saveRDS(all_exp, "intermediate_files/tidy_data_update25-04-24.rds")
```

# 2. Taxonomy table

suffix _tax = taxonomy table

To go faster while generating the taxonomy, use a NCBI entrez key.
First, generate a key cf https://ncbiinsights.ncbi.nlm.nih.gov/2017/11/02/new-api-keys-for-the-e-utilities/
Then, set your environment by doing once:
usethis::edit_r_environ()
ENTREZ_KEY='youractualkey' # To write in the environment

NB: Even with the key, error (400) appears but can be solved by using a loop.

## macrofaune_surface

```{r}
macrofaune_surface_query <- macrofaune_surface_1 %>% distinct(name)
temp <- gnr_resolve(macrofaune_surface_query$name, preferred_data_sources = c(1,3,4,11,12), best_match_only = T) # 1 = CLC, 3 = ITIS, 4 = NCBI, 11 = GBIF, 12 = EOL (https://resolver.globalnames.org/data_sources)
diff <- setdiff(macrofaune_surface_query$name, temp$user_supplied_name) 
print(diff)
# Manual cleaning
## Pezottetix not found because wrong spelling
macrofaune_surface_query$name[macrofaune_surface_query$name == "Pezottetix"] <- "Pezotettix"
# Run again from temp... and check diff = 0 now
```

```{r, echo=FALSE}
macrofaune_surface_tax_0 = NULL
for (i in 1: nrow(macrofaune_surface_query)) {
classes_i <- try(tax_name(sci = macrofaune_surface_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))
if (class(classes_i)=="try-error") {
Sys.sleep(10)
classes_i <- try(tax_name(sci = macrofaune_surface_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))}
macrofaune_surface_tax_0 <- rbind(macrofaune_surface_tax_0, classes_i)
}

notaxfoundboth <- macrofaune_surface_tax_0[!complete.cases(macrofaune_surface_tax_0$kingdom),]
notaxfoundonedb <- notaxfoundboth %>% group_by(query) %>% filter(n() ==1) # These are the taxa found in only one database (not found in the database in this object = found in the other database in macrofaune_foliar_tax_0). Therefore, if we filter NCBI (by default) results in macrofaune_foliar_tax_0, we must also keep ITIS results for the taxa with no NCBI results in this objects. These taxa to keep are saved in the following vector :
keepitis <- c(subset(notaxfoundonedb, db == 'ncbi')$query)
taxnotfound_ncbianditis <- subset(notaxfoundboth,duplicated(query)) # These are the taxa not found in any database. We will export the list, fill it manually and reimport it.
write.csv(taxnotfound_ncbianditis[,-1], "intermediate_files/macrofaune_surface_taxnotfound_ncbianditis.csv") # Fill cells with info found on internet, save it to x_mod and import it
taxfound_manually <- read.csv("intermediate_files/macrofaune_surface_taxnotfound_ncbianditis_mod.csv", sep = ";")
taxfound_manually <- taxfound_manually[complete.cases(taxfound_manually$kingdom),-c(9,10)]

# Keep NCBI results in macrofaune_surface_tax and add ITIS results and manual taxonomy
taxfound_ncbi <- macrofaune_surface_tax_0[macrofaune_surface_tax_0$db == 'ncbi' & complete.cases(macrofaune_surface_tax_0$kingdom), -1]
taxfound_itisonly <- macrofaune_surface_tax_0[macrofaune_surface_tax_0$db == 'itis' & macrofaune_surface_tax_0$query %in% keepitis, ]
macrofaune_surface_tax <- bind_rows(taxfound_ncbi, taxfound_itisonly[,-1], taxfound_manually) %>% mutate(community = "macrofaune_surface")
```

## macrofaune_aerial

```{r}
macrofaune_aerial_query <- macrofaune_aerial_1 %>% distinct(name)
temp <- gnr_resolve(macrofaune_aerial_query$name, preferred_data_sources = c(1,3,4,11,12), best_match_only = T) # 1 = CLC, 3 = ITIS, 4 = NCBI, 11 = GBIF, 12 = EOL (https://resolver.globalnames.org/data_sources)
diff <- setdiff(macrofaune_aerial_query$name, temp$user_supplied_name) 
print(diff)
# Manual cleaning
## Belytini not found because its a tribu of Belytinae
macrofaune_aerial_query$name[macrofaune_aerial_query$name == "Belytini"] <- "Belytinae"
# Run again from temp... and check diff = 0 now
```

```{r, echo=FALSE}
macrofaune_aerial_tax_0 = NULL
for (i in 1: nrow(macrofaune_aerial_query)) {
classes_i <- try(tax_name(sci = macrofaune_aerial_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))
if (class(classes_i)=="try-error") {
Sys.sleep(10)
classes_i <- try(tax_name(sci = macrofaune_aerial_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))}
macrofaune_aerial_tax_0 <- rbind(macrofaune_aerial_tax_0, classes_i)
}

notaxfoundboth <- macrofaune_aerial_tax_0[!complete.cases(macrofaune_aerial_tax_0$kingdom),]
notaxfoundonedb <- notaxfoundboth %>% group_by(query) %>% filter(n() ==1) # These are the taxa found in only one database (not found in the database in this object = found in the other database in macrofaune_foliar_tax_0). Therefore, if we filter NCBI (by default) results in macrofaune_foliar_tax_0, we must also keep ITIS results for the taxa with no NCBI results in this objects. These taxa to keep are saved in the following vector :
keepitis <- c(subset(notaxfoundonedb, db == 'ncbi')$query)
taxnotfound_ncbianditis <- subset(notaxfoundboth,duplicated(query)) # These are the taxa not found in any database. We will export the list, fill it manually and reimport it.
write.csv(taxnotfound_ncbianditis[,-1], "intermediate_files/macrofaune_aerial_taxnotfound_ncbianditis.csv") # Fill cells with info found on internet, save it to x_mod and import it
taxfound_manually <- read.csv("intermediate_files/macrofaune_aerial_taxnotfound_ncbianditis_mod.csv", sep = ";")
taxfound_manually <- taxfound_manually[complete.cases(taxfound_manually$kingdom),-c(9,10)]

# Keep NCBI results in macrofaune_aerial_tax and add ITIS results and manual taxonomy
taxfound_ncbi <- macrofaune_aerial_tax_0[macrofaune_aerial_tax_0$db == 'ncbi' & complete.cases(macrofaune_aerial_tax_0$kingdom), -1]
taxfound_itisonly <- macrofaune_aerial_tax_0[macrofaune_aerial_tax_0$db == 'itis' & macrofaune_aerial_tax_0$query %in% keepitis, ]
macrofaune_aerial_tax <- bind_rows(taxfound_ncbi, taxfound_itisonly[,-1], taxfound_manually) %>% mutate(community = "macrofaune_aerial")
```

## macrofaune_foliar

```{r}
macrofaune_foliar_query <- macrofaune_foliar_1 %>% distinct(name)
temp <- gnr_resolve(macrofaune_foliar_query$name, preferred_data_sources = c(1,3,4,11,12), best_match_only = T) # 1 = CLC, 3 = ITIS, 4 = NCBI, 11 = GBIF, 12 = EOL (https://resolver.globalnames.org/data_sources)
diff <- setdiff(macrofaune_foliar_query$name, temp$user_supplied_name) 
print(diff)
# Manual cleaning
## Phonognathidae not found because wrong spelling
macrofaune_foliar_query$name[macrofaune_foliar_query$name == "Phonognathidae"] <- "Phonognathinae"
## vide should be removed
macrofaune_foliar_query <- macrofaune_foliar_query[!(macrofaune_foliar_query$name %in% "vide"),]
# Run again from temp... and check diff = 0 now
```

```{r, echo=FALSE}
macrofaune_foliar_tax_0 = NULL
for (i in 1: nrow(macrofaune_foliar_query)) {
classes_i <- try(tax_name(sci = macrofaune_foliar_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))
if (class(classes_i)=="try-error") {
Sys.sleep(10)
classes_i <- try(tax_name(sci = macrofaune_foliar_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))}
macrofaune_foliar_tax_0 <- rbind(macrofaune_foliar_tax_0, classes_i)
}

notaxfoundboth <- macrofaune_foliar_tax_0[!complete.cases(macrofaune_foliar_tax_0$kingdom),]
notaxfoundonedb <- notaxfoundboth %>% group_by(query) %>% filter(n() ==1) # These are the taxa found in only one database (not found in the database in this object = found in the other database in macrofaune_foliar_tax_0). Therefore, if we filter NCBI (by default) results in macrofaune_foliar_tax_0, we must also keep ITIS results for the taxa with no NCBI results in this objects. These taxa to keep are saved in the following vector :
keepitis <- c(subset(notaxfoundonedb, db == 'ncbi')$query)
taxnotfound_ncbianditis <- subset(notaxfoundboth,duplicated(query)) # These are the taxa not found in any database. We will export the list, fill it manually and reimport it.
write.csv(taxnotfound_ncbianditis[,-1], "intermediate_files/macrofaune_foliar_taxnotfound_ncbianditis.csv") # Fill cells with info found on internet, save it to x_mod and import it
taxfound_manually <- read.csv("intermediate_files/macrofaune_foliar_taxnotfound_ncbianditis_mod.csv", sep = ";")
taxfound_manually <- taxfound_manually[complete.cases(taxfound_manually$kingdom),-c(9,10)]

# Keep NCBI results in macrofaune_foliar_tax and add ITIS results and manual taxonomy
taxfound_ncbi <- macrofaune_foliar_tax_0[macrofaune_foliar_tax_0$db == 'ncbi' & complete.cases(macrofaune_foliar_tax_0$kingdom), -1]
taxfound_itisonly <- macrofaune_foliar_tax_0[macrofaune_foliar_tax_0$db == 'itis' & macrofaune_foliar_tax_0$query %in% keepitis, ]
macrofaune_foliar_tax <- bind_rows(taxfound_ncbi, taxfound_itisonly[,-1], taxfound_manually) %>% mutate(community = "macrofaune_foliar")
```

## nematodes

```{r}
nematodes_query <- nematodes_1 %>% distinct(name)
temp <- gnr_resolve(nematodes_query$name, preferred_data_sources = c(1,3,4,11,12), best_match_only = T) # 1 = CLC, 3 = ITIS, 4 = NCBI, 11 = GBIF, 12 = EOL (https://resolver.globalnames.org/data_sources)
diff <- setdiff(nematodes_query$name, temp$user_supplied_name) 
print(diff)
# diff = 0 so no need for manual cleaning
```

```{r, echo=FALSE}
nematodes_tax_0 = NULL
for (i in 1: nrow(nematodes_query)) {
classes_i <- try(tax_name(sci = nematodes_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))
if (class(classes_i)=="try-error") {
Sys.sleep(10)
classes_i <- try(tax_name(sci = nematodes_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))}
nematodes_tax_0 <- rbind(nematodes_tax_0, classes_i)
}

notaxfoundboth <- nematodes_tax_0[!complete.cases(nematodes_tax_0$kingdom),] 
taxnotfound_ncbianditis <- subset(notaxfoundboth,duplicated(query)) # All taxa are found with NCBI or ITIS.

# Keep NCBI results in nematodes_tax and add ITIS results and manual taxonomy
nematodes_tax <- nematodes_tax_0[nematodes_tax_0$db == 'ncbi' & complete.cases(nematodes_tax_0$kingdom), -1] %>% mutate(community = "nematodes")
```

## micro-arthropodes

```{r}
micro_arthropodes_query <- micro_arthropodes_1 %>% distinct(name)
temp <- gnr_resolve(micro_arthropodes_query$name, preferred_data_sources = c(1,3,4,11,12), best_match_only = T) # 1 = CLC, 3 = ITIS, 4 = NCBI, 11 = GBIF, 12 = EOL (https://resolver.globalnames.org/data_sources)
diff <- setdiff(micro_arthropodes_query$name, temp$user_supplied_name) 
print(diff)
# Manual cleaning
## NA should be removed
micro_arthropodes_query <- micro_arthropodes_query[!(micro_arthropodes_query$name %in% "NA"),]
micro_arthropodes_query <- data.frame(micro_arthropodes_query)
micro_arthropodes_query <- micro_arthropodes_query %>%  rename(name = micro_arthropodes_query)
# diff = 0 now
```

```{r, echo=FALSE}
micro_arthropodes_tax_0 = NULL
for (i in 1: nrow(micro_arthropodes_query)) {
classes_i <- try(tax_name(sci = micro_arthropodes_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))
if (class(classes_i)=="try-error") {
Sys.sleep(10)
classes_i <- try(tax_name(sci = micro_arthropodes_query$name[i], get = c("kingdom", "phylum", "class", "order", "family", "genus", "species"), db = "both", ask = FALSE))}
micro_arthropodes_tax_0 <- rbind(micro_arthropodes_tax_0, classes_i)
}

notaxfoundboth <- micro_arthropodes_tax_0[!complete.cases(micro_arthropodes_tax_0$kingdom),]
notaxfoundonedb <- notaxfoundboth %>% group_by(query) %>% filter(n() ==1) # These are the taxa found in only one database (not found in the database in this object = found in the other database in micro_arthropodes_tax_0). Therefore, if we filter NCBI (by default) results in micro_arthropodes_tax_0, we must also keep ITIS results for the taxa with no NCBI results in this objects. These taxa to keep are saved in the following vector :
keepitis <- c(subset(notaxfoundonedb, db == 'ncbi')$query)
taxnotfound_ncbianditis <- subset(notaxfoundboth,duplicated(query)) # These are the taxa not found in any database. We will export the list, fill it manually and reimport it.
write.csv(taxnotfound_ncbianditis[,-1], "intermediate_files/micro_arthropodes_taxnotfound_ncbianditis.csv") # Fill cells with info found on internet, save it to x_mod and import it
taxfound_manually <- read.csv("intermediate_files/micro_arthropodes_taxnotfound_ncbianditis_mod.csv", sep = ";")
taxfound_manually <- taxfound_manually[complete.cases(taxfound_manually$kingdom),-c(9,10)]

# Keep NCBI results in micro_arthropodes_tax and add ITIS results and manual taxonomy
taxfound_ncbi <- micro_arthropodes_tax_0[micro_arthropodes_tax_0$db == 'ncbi' & complete.cases(micro_arthropodes_tax_0$kingdom), -1]
taxfound_itisonly <- micro_arthropodes_tax_0[micro_arthropodes_tax_0$db == 'itis' & micro_arthropodes_tax_0$query %in% keepitis, ]
micro_arthropodes_tax <- bind_rows(taxfound_ncbi, taxfound_itisonly[,-1], taxfound_manually) %>% mutate(community = "micro_arthropodes")
```

## micro-organisms

```{r}
bacteria_query <- bacteria_1 %>% distinct(seed_id, blast_taxonomy)
bacteria_query <- bacteria_query %>% rename(query = seed_id)
bacteria_query <- bacteria_query %>% rename(name = blast_taxonomy)
bacteria_tax <- bacteria_query %>% 
   separate(col = name, into = c("kingdom","phylum","class","order", "family", "genus", "species"), sep = ";")
bacteria_tax <- bacteria_tax %>% mutate(community = "bacteria")

fungi_query <- fungi_1 %>% distinct(seed_id, blast_taxonomy)
fungi_query <- fungi_query %>%  rename(query = seed_id)
fungi_query <- fungi_query %>%  rename(name = blast_taxonomy)
fungi_tax <- fungi_query %>% 
   separate(col = name, into = c("kingdom","phylum","class","order", "family", "genus", "species"), sep = ";")
fungi_tax[] <- lapply(fungi_tax, gsub, pattern='.__', replacement='')
fungi_tax <- fungi_tax %>% mutate(community = "fungi")

cercozoa_query <- cercozoa_1 %>% distinct(seed_id, blast_taxonomy)
cercozoa_query <- cercozoa_query %>%  rename(query = seed_id)
cercozoa_query <- cercozoa_query %>%  rename(name = blast_taxonomy)
cercozoa_tax <- cercozoa_query %>% 
   separate(col = name, into = c("kingdom","phylum","class","order", "family", "genus", "species"), sep = ";")
cercozoa_tax <- cercozoa_tax %>% mutate(community = "cercozoa")
```

# Export tax_table

```{r}
all_tax <- bind_rows(macrofaune_surface_tax, macrofaune_aerial_tax, macrofaune_foliar_tax, nematodes_tax, micro_arthropodes_tax, bacteria_tax, fungi_tax, cercozoa_tax)
write.csv(all_tax, "intermediate_files/tax_table_update25-04-24.csv")
```

# 3. Functional table

```{r}
library(GratinNavigatoR)

endpoint_url <- "http://129.88.204.79:7200/repositories/gratin"
sources <- get.sources(endpoint = endpoint_url)

tax_table <- read.csv("intermediate_files/tax_table_update25-04-24.csv")[,-1]
```

## macrofaune_surface

```{r}
macrofaune_surface_fun_0 <- tax_table[ which(tax_table$community=='macrofaune_surface'), ] %>% 
unique(macrofaune_surface_fun_0)

numberoftaxa <- as.data.frame(t(sapply(macrofaune_surface_fun_0[,-9], function(x) n_distinct(x))))

macrofaune_surface_info_guilds_family <- get.guilds(sciName = unique(macrofaune_surface_fun_0$family), endpoint = endpoint_url)
write.csv(apply(macrofaune_surface_info_guilds_family,2,as.character), "intermediate_files/fun_table/macrofaune_surface_info_guilds_family.csv")

numberofguilds_family <- n_distinct(macrofaune_surface_info_guilds_family$guildName) # 48

macrofaune_surface_info_diets_family <- get.diets(sciName = unique(macrofaune_surface_fun_0$family), endpoint = endpoint_url)
write.csv(apply(macrofaune_surface_info_diets_family,2,as.character), "intermediate_files/fun_table/macrofaune_surface_info_diets_family.csv")

macrofaune_surface_info_groups_family <- get.trophic.groups(sciName = unique(macrofaune_surface_fun_0$family), endpoint = endpoint_url)
write.csv(apply(macrofaune_surface_info_groups_family,2,as.character), "intermediate_files/fun_table/macrofaune_surface_info_groups_family.csv")

macrofaune_surface_interactions_family <- get.interactions(sciName = unique(macrofaune_surface_fun_0$family), endpoint = endpoint_url)
write.csv(apply(macrofaune_surface_interactions_family,2,as.character), "intermediate_files/fun_table/macrofaune_surface_interactions_family.csv")
```

# 4. Analyses

```{r}
# import macrofaune_surface_info_diets_family and tidy_data
fun_table_macrofaune_surface_info_diets_family <- read.csv("intermediate_files/fun_table/macrofaune_surface_info_diets_family.csv")[,-1]
tidy_data_macrofaune_surface <- tidy_data[ which(tidy_data$community=='macrofaune_surface'), ]

# subset herbivorous
fun_table_macrofaune_surface_family_subset <- fun_table_macrofaune_surface_info_diets_family[ which(fun_table_macrofaune_surface_info_diets_family$dietName=='herbivorous' | fun_table_macrofaune_surface_info_diets_family$dietName=='predaceous'), ]

# keep unique rows per family
fun_table_macrofaune_surface_family_subset_unique <- unique(fun_table_macrofaune_surface_family_subset[,c(1,6)])

# link tidy_data and fun_table
tidy_data_macrofaune_surface$dietName <- fun_table_macrofaune_surface_family_subset_unique$dietName[match(tidy_data_macrofaune_surface$name, fun_table_macrofaune_surface_family_subset_unique$queryName)]

# replace na by "other diet" (more diets can be included by modifying the subset above)
tidy_data_macrofaune_surface[is.na(tidy_data_macrofaune_surface)] = "other diet"
```

```{r}
dt_graph <- tidy_data_macrofaune_surface %>% separate_wider_delim(full_uhbr, "_", names = c("usage", "habitat", "block", "replicate"))

dt_graph <- dt_graph %>% group_by(usage, habitat, block, replicate, dietName) %>% summarise_all(mean) %>% ungroup()

library(ggplot2)
ggplot(data = dt_graph, aes(x = dietName, y = abundance)) + geom_boxplot() + facet_grid(cols = vars(habitat))
```

